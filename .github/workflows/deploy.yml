name: Auto Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
    
    - name: Deploy to DigitalOcean
      run: |
        SERVER_IP="146.190.249.76"
        DEPLOY_PATH="/var/www/html/edbetosolutions"
        
        # Add server to known hosts
        ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
        
        # Deploy to server
        ssh -o StrictHostKeyChecking=no root@$SERVER_IP << 'EOF'
          set -e
          
          echo "ðŸš€ Auto-deploying edbetosolutions..."
          
          # Navigate to deployment directory
          cd /var/www/html/edbetosolutions
          
          # Pull latest changes
          git fetch origin
          git reset --hard origin/main
          git pull origin main
          
          # Fix ownership and permissions
          chown -R www-data:www-data /var/www/html/edbetosolutions
          chmod -R 755 /var/www/html/edbetosolutions
          find /var/www/html/edbetosolutions -type f -exec chmod 644 {} \;
          
          # Ensure directory permissions
          chmod 755 /var/www/html/edbetosolutions
          
          # Test nginx and reload
          nginx -t && systemctl reload nginx
          
          echo "âœ… Deployment completed!"
          
        EOF
