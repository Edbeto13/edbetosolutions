name: 🔍 Server Diagnostics

on:
  workflow_dispatch:
    inputs:
      diagnostic_type:
        description: 'Type of diagnostic to run'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - permissions
        - nginx
        - files

jobs:
  diagnose:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Server Diagnostics
      env:
        DO_TOKEN: ${{ secrets.DO_TOKEN }}
        DROPLET_ID: ${{ secrets.DROPLET_ID }}
      run: |
        echo "🔍 Starting server diagnostics..."
        
        # Install doctl
        wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
        tar xf doctl-1.104.0-linux-amd64.tar.gz
        sudo mv doctl /usr/local/bin
        
        # Authenticate
        doctl auth init --access-token $DO_TOKEN
        
        # Run comprehensive diagnostics
        echo "📊 Running diagnostics on droplet..."
        doctl compute ssh $DROPLET_ID --ssh-command "
          echo '=== 🔍 DIAGNÓSTICO COMPLETO ===' &&
          echo '' &&
          echo '📂 Estructura de archivos:' &&
          ls -la /var/www/html/edbetosolutions/ &&
          echo '' &&
          echo '📄 Archivos HTML encontrados:' &&
          find /var/www/html/edbetosolutions -name '*.html' -type f &&
          echo '' &&
          echo '🔒 Permisos del directorio raíz:' &&
          ls -la /var/www/html/edbetosolutions/index.html &&
          echo '' &&
          echo '📁 Permisos del directorio frontend:' &&
          ls -la /var/www/html/edbetosolutions/frontend/ &&
          echo '' &&
          echo '🌐 Estado de nginx:' &&
          systemctl is-active nginx &&
          echo '' &&
          echo '📋 Últimos logs de error:' &&
          tail -5 /var/log/nginx/error.log &&
          echo '' &&
          echo '✅ Diagnóstico completado'
        "
        
        echo "🔧 Attempting permission fix..."
        doctl compute ssh $DROPLET_ID --ssh-command "
          cd /var/www/html/edbetosolutions &&
          chown -R www-data:www-data . &&
          chmod -R 755 . &&
          chmod 644 index.html &&
          systemctl reload nginx &&
          echo '✅ Permissions updated'
        "
        
        echo "✅ Diagnostics completed!"
