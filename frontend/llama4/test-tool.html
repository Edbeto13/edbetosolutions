<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Prueba - Llama 4 NVIDIA NIM</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        h1 {
            color: #2c3e50;
            margin: 0 0 10px 0;
        }
        .description {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .tabs {
            display: flex;
            gap: 1px;
            margin-bottom: 20px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f5f5f5;
            flex: 1;
            text-align: center;
            transition: all 0.3s;
        }
        .tab.active {
            background: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
        }
        .tab-content.active {
            display: block;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: inherit;
        }
        textarea {
            min-height: 100px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status.success {
            background: #d5f5e3;
            color: #27ae60;
        }
        .status.error {
            background: #f5e3e3;
            color: #e74c3c;
        }
        .status.warning {
            background: #fcf3cf;
            color: #f39c12;
        }
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .chat-container {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
        }
        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background: white;
        }
        .chat-input {
            flex: 1;
            margin-right: 10px;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            max-width: 80%;
        }
        .user-message {
            background: #e3f2fd;
            align-self: flex-end;
            margin-left: auto;
        }
        .assistant-message {
            background: #e8f5e9;
            align-self: flex-start;
        }
        .endpoint-display {
            font-family: monospace;
            background: #f1f1f1;
            padding: 5px;
            border-radius: 3px;
            color: #333;
        }
        .collapsible {
            cursor: pointer;
            background-color: #f1f1f1;
            padding: 10px;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: #f9f9f9;
            border-radius: 0 0 4px 4px;
        }
        .collapsible-content-inner {
            padding: 15px;
        }
        .test-result {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.success {
            background: #d5f5e3;
            border-left: 4px solid #27ae60;
        }
        .test-result.error {
            background: #f5e3e3;
            border-left: 4px solid #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Herramienta de Prueba - Llama 4 con NVIDIA NIM</h1>
            <div class="description">
                Esta herramienta permite probar las diferentes funciones del servidor NVIDIA API para Llama 4
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="status">Estado del Servicio</div>
            <div class="tab" data-tab="chat">Chat de Prueba</div>
            <div class="tab" data-tab="api">API Directa</div>
            <div class="tab" data-tab="diagnostics">Diagnósticos</div>
        </div>
        
        <div class="tab-content active" id="status-tab">
            <h2>Estado del Servicio</h2>
            <p>Verifica el estado actual de los servicios necesarios para Llama 4.</p>
            
            <button id="check-status" class="action-button">Comprobar Estado</button>
            
            <div class="result" id="status-result">
                <div>Ejecuta la comprobación para ver el estado...</div>
            </div>
        </div>
        
        <div class="tab-content" id="chat-tab">
            <h2>Chat de Prueba</h2>
            <p>Prueba el chat con Llama 4 directamente desde esta interfaz.</p>
            
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message assistant-message">
                        ¡Hola! Soy Llama 4 (NVIDIA NIM). ¿En qué puedo ayudarte hoy?
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Escribe tu mensaje aquí...">
                    <button id="send-message" class="action-button">Enviar</button>
                </div>
            </div>
            
            <div class="input-group">
                <label>Historial del Chat</label>
                <div class="result" id="chat-history">
                    <div>No hay mensajes aún...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="api-tab">
            <h2>API Directa</h2>
            <p>Interactúa directamente con los endpoints de la API.</p>
            
            <div class="input-group">
                <label>Endpoint</label>
                <select id="endpoint-select">
                    <option value="/api/status">Estado General (/api/status)</option>
                    <option value="/api/chat/status">Estado del Chat (/api/chat/status)</option>
                    <option value="/health">Health Check (/health)</option>
                    <option value="/api/chat">Chat API (/api/chat) [POST]</option>
                </select>
            </div>
            
            <div class="input-group" id="body-container" style="display:none;">
                <label>Cuerpo del Request (JSON)</label>
                <textarea id="request-body">{
    "messages": [
        {"role": "user", "content": "Hola, ¿cómo estás?"}
    ],
    "temperature": 0.7,
    "max_tokens": 500
}</textarea>
            </div>
            
            <div class="input-group">
                <button id="send-request" class="action-button">Enviar Request</button>
            </div>
            
            <div class="input-group">
                <label>Respuesta</label>
                <div class="result" id="api-result">
                    <div>Envía una request para ver la respuesta...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="diagnostics-tab">
            <h2>Diagnósticos</h2>
            <p>Realiza diagnósticos completos de la integración con NVIDIA NIM.</p>
            
            <div class="input-group">
                <button id="run-diagnostics" class="action-button">Ejecutar Diagnósticos</button>
                <button id="test-nvidia" class="action-button">Probar Conexión NVIDIA</button>
            </div>
            
            <div id="diagnostics-results">
                <!-- Los resultados de diagnóstico aparecerán aquí -->
            </div>
        </div>
    </div>

    <script>
        // Base URL para la API
        const BASE_URL = window.location.origin; // 'https://edbetosolutions.tech'
        let chatHistory = [];
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            // Tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // API Tab
            const endpointSelect = document.getElementById('endpoint-select');
            const bodyContainer = document.getElementById('body-container');
            
            endpointSelect.addEventListener('change', () => {
                bodyContainer.style.display = endpointSelect.value === '/api/chat' ? 'block' : 'none';
            });
            
            // Status Check
            document.getElementById('check-status').addEventListener('click', checkStatus);
            
            // Chat
            document.getElementById('send-message').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // API
            document.getElementById('send-request').addEventListener('click', sendAPIRequest);
            
            // Diagnostics
            document.getElementById('run-diagnostics').addEventListener('click', runDiagnostics);
            document.getElementById('test-nvidia').addEventListener('click', testNVIDIAConnection);
            
            // Iniciar con una verificación de estado
            checkStatus();
        });
        
        // Función para verificar estado
        async function checkStatus() {
            const statusResult = document.getElementById('status-result');
            statusResult.innerHTML = '<div>Verificando estado... <div class="loader"></div></div>';
            
            try {
                // Verificar estado general
                const statusResponse = await fetch(`${BASE_URL}/api/status`);
                const statusData = await statusResponse.json();
                
                // Verificar estado del chat
                const chatStatusResponse = await fetch(`${BASE_URL}/api/chat/status`);
                const chatStatusCode = chatStatusResponse.status;
                const chatStatusData = await chatStatusResponse.json();
                
                // Health check
                const healthResponse = await fetch(`${BASE_URL}/health`);
                const healthData = await healthResponse.json();
                
                let html = `
                    <h3>Resultados:</h3>
                    <div><strong>API Status:</strong> 
                        <span class="status ${statusData.status === 'ok' ? 'success' : 'error'}">
                            ${statusData.status === 'ok' ? '✓ Activo' : '✗ Error'}
                        </span>
                    </div>
                    <div><strong>Health Check:</strong> 
                        <span class="status ${healthData.status === 'healthy' ? 'success' : 'error'}">
                            ${healthData.status === 'healthy' ? '✓ Saludable' : '✗ Error'}
                        </span>
                    </div>
                    <div><strong>Chat API:</strong> 
                        <span class="status ${chatStatusCode === 200 ? 'success' : 'error'}">
                            ${chatStatusCode === 200 ? '✓ Disponible' : '✗ No disponible'}
                        </span>
                    </div>
                    
                    <h3>Detalles:</h3>
                    <pre>${JSON.stringify({
                        apiStatus: statusData,
                        healthCheck: healthData,
                        chatStatus: chatStatusData
                    }, null, 2)}</pre>
                `;
                
                statusResult.innerHTML = html;
                
            } catch (error) {
                statusResult.innerHTML = `
                    <div class="status error">✗ Error de conexión</div>
                    <p>No se pudo conectar con el servidor. Verifica que el servidor esté en ejecución.</p>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        // Función para enviar mensaje en el chat
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Limpiar input
            input.value = '';
            
            // Añadir mensaje del usuario
            addChatMessage(message, 'user');
            
            // Añadir al historial
            chatHistory.push({
                role: 'user',
                content: message
            });
            
            // Actualizar historial
            updateChatHistory();
            
            // Mostrar indicador de carga
            const loadingId = showLoading();
            
            try {
                // Enviar a la API
                const response = await fetch(`${BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Remover indicador de carga
                removeLoading(loadingId);
                
                // Obtener respuesta
                const assistantMessage = data.choices[0].message.content;
                
                // Añadir respuesta del asistente
                addChatMessage(assistantMessage, 'assistant');
                
                // Añadir al historial
                chatHistory.push({
                    role: 'assistant',
                    content: assistantMessage
                });
                
                // Actualizar historial
                updateChatHistory();
                
            } catch (error) {
                // Remover indicador de carga
                removeLoading(loadingId);
                
                // Mostrar error
                addChatMessage(`❌ Error: ${error.message}`, 'assistant');
                console.error('Error en chat:', error);
            }
        }
        
        // Función para añadir mensaje al chat
        function addChatMessage(content, role) {
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}-message`;
            messageElement.textContent = content;
            chatMessages.appendChild(messageElement);
            
            // Scroll al final
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Función para actualizar historial de chat
        function updateChatHistory() {
            const chatHistoryElement = document.getElementById('chat-history');
            chatHistoryElement.innerHTML = `<pre>${JSON.stringify(chatHistory, null, 2)}</pre>`;
        }
        
        // Función para mostrar indicador de carga
        function showLoading() {
            const chatMessages = document.getElementById('chat-messages');
            const loadingElement = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingElement.id = loadingId;
            loadingElement.className = 'message assistant-message';
            loadingElement.innerHTML = 'Escribiendo<span class="loader"></span>';
            chatMessages.appendChild(loadingElement);
            
            // Scroll al final
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return loadingId;
        }
        
        // Función para remover indicador de carga
        function removeLoading(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }
        
        // Función para enviar request a la API
        async function sendAPIRequest() {
            const endpoint = document.getElementById('endpoint-select').value;
            const resultElement = document.getElementById('api-result');
            
            resultElement.innerHTML = '<div>Enviando request... <div class="loader"></div></div>';
            
            try {
                let response;
                
                if (endpoint === '/api/chat') {
                    // POST request
                    const bodyInput = document.getElementById('request-body');
                    let body;
                    
                    try {
                        body = JSON.parse(bodyInput.value);
                    } catch (e) {
                        resultElement.innerHTML = `<div class="status error">✗ Error en JSON</div><pre>${e.message}</pre>`;
                        return;
                    }
                    
                    response = await fetch(`${BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });
                } else {
                    // GET request
                    response = await fetch(`${BASE_URL}${endpoint}`);
                }
                
                const statusClass = response.ok ? 'success' : 'error';
                const statusText = response.ok ? '✓ Éxito' : '✗ Error';
                
                let responseText;
                try {
                    const data = await response.json();
                    responseText = JSON.stringify(data, null, 2);
                } catch (e) {
                    responseText = await response.text();
                }
                
                resultElement.innerHTML = `
                    <div class="status ${statusClass}">${statusText} - ${response.status} ${response.statusText}</div>
                    <pre>${responseText}</pre>
                `;
                
            } catch (error) {
                resultElement.innerHTML = `
                    <div class="status error">✗ Error de conexión</div>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        // Función para ejecutar diagnósticos
        async function runDiagnostics() {
            const resultsElement = document.getElementById('diagnostics-results');
            resultsElement.innerHTML = '<div>Ejecutando diagnósticos... <div class="loader"></div></div>';
            
            const tests = [
                { name: 'Conectividad Básica', endpoint: '/health', method: 'GET' },
                { name: 'Estado del API', endpoint: '/api/status', method: 'GET' },
                { name: 'Estado del Chat', endpoint: '/api/chat/status', method: 'GET' },
                { name: 'Endpoint del Chat', endpoint: '/api/chat', method: 'POST', body: {
                    messages: [{ role: 'user', content: 'Prueba de diagnóstico' }],
                    temperature: 0.5,
                    max_tokens: 50
                } }
            ];
            
            let html = '<h3>Resultados de Diagnósticos:</h3>';
            let allPassed = true;
            
            for (const test of tests) {
                try {
                    let response;
                    
                    if (test.method === 'GET') {
                        response = await fetch(`${BASE_URL}${test.endpoint}`);
                    } else {
                        response = await fetch(`${BASE_URL}${test.endpoint}`, {
                            method: test.method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(test.body)
                        });
                    }
                    
                    const success = response.ok;
                    allPassed = allPassed && success;
                    
                    let responseText;
                    try {
                        const data = await response.json();
                        responseText = JSON.stringify(data, null, 2);
                    } catch (e) {
                        responseText = await response.text();
                    }
                    
                    html += `
                        <div class="test-result ${success ? 'success' : 'error'}">
                            <strong>${test.name}:</strong> 
                            <span class="status ${success ? 'success' : 'error'}">
                                ${success ? '✓ Éxito' : '✗ Error'} - ${response.status} ${response.statusText}
                            </span>
                            <div class="collapsible-content" style="max-height: none;">
                                <div class="collapsible-content-inner">
                                    <pre>${responseText}</pre>
                                </div>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    allPassed = false;
                    html += `
                        <div class="test-result error">
                            <strong>${test.name}:</strong> 
                            <span class="status error">✗ Error de conexión</span>
                            <div class="collapsible-content" style="max-height: none;">
                                <div class="collapsible-content-inner">
                                    <pre>${error.message}</pre>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Conclusión
            html += `
                <div style="margin-top: 20px; padding: 10px; background: ${allPassed ? '#d5f5e3' : '#f5e3e3'}; border-radius: 4px;">
                    <strong>Diagnóstico Final:</strong> 
                    ${allPassed ? 
                        '✅ Todos los servicios funcionan correctamente.' : 
                        '❌ Algunos servicios presentan problemas. Revisa los detalles arriba.'}
                </div>
            `;
            
            resultsElement.innerHTML = html;
        }
        
        // Función para probar conexión directa con NVIDIA
        async function testNVIDIAConnection() {
            const resultsElement = document.getElementById('diagnostics-results');
            resultsElement.innerHTML = '<div>Probando conexión NVIDIA... <div class="loader"></div></div>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: 'Test de conexión NVIDIA. Responde con una sola palabra.' }],
                        temperature: 0.3,
                        max_tokens: 20
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                
                resultsElement.innerHTML = `
                    <div class="test-result success">
                        <strong>Conexión NVIDIA NIM:</strong> 
                        <span class="status success">✓ Conectado</span>
                        <p>Respuesta recibida del modelo Llama 4 vía NVIDIA NIM</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                resultsElement.innerHTML = `
                    <div class="test-result error">
                        <strong>Conexión NVIDIA NIM:</strong> 
                        <span class="status error">✗ Error</span>
                        <p>No se pudo conectar con NVIDIA NIM API</p>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
